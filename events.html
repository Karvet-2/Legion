<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>События гильдии - Perfect World Mobile</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="bg-dark text-white py-3">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="mb-0">
              <a href="index.html" class="text-white text-decoration-none"
                >Гильдия Perfect World Mobile</a
              >
            </h1>
          </div>
          <div class="col-md-6">
            <nav class="navbar navbar-expand-lg navbar-dark">
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Главная</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="members.html">Участники</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" href="events.html">События</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="packs.html">Круги</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="statistics.html">Статистика</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">Выход</a>
                  </li>
                </ul>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <h2 class="mb-0">События гильдии</h2>
              <button
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#addEventModal"
              >
                Добавить событие
              </button>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <input
                    type="text"
                    id="tableFilter"
                    class="form-control"
                    placeholder="Поиск по событиям..."
                  />
                </div>
                <div class="col-md-6">
                  <select id="eventTypeFilter" class="form-select">
                    <option value="all">Все типы событий</option>
                    <option value="Raid">Рейд</option>
                    <option value="Dungeon">Подземелье</option>
                    <option value="WorldBoss">Мировой босс</option>
                    <option value="GuildWar">Война гильдий</option>
                    <option value="Other">Другое</option>
                  </select>
                </div>
              </div>

              <div id="eventsTableContainer">
                <div class="alert alert-info">Загрузка данных...</div>
              </div>
            </div>
            <div class="card-footer">
              <div class="d-flex justify-content-between">
                <span>Всего событий: <strong id="totalEvents">0</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно добавления события -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Добавление нового события</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addEventForm">
              <div class="mb-3">
                <label for="title" class="form-label">Название *</label>
                <input type="text" class="form-control" id="title" required />
              </div>

              <div class="mb-3">
                <label for="type" class="form-label">Тип *</label>
                <select class="form-select" id="type" required>
                  <option value="">Выберите тип</option>
                  <option value="Raid">Рейд</option>
                  <option value="Dungeon">Подземелье</option>
                  <option value="WorldBoss">Мировой босс</option>
                  <option value="GuildWar">Война гильдий</option>
                  <option value="Other">Другое</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="date" class="form-label">Дата *</label>
                <input type="date" class="form-control" id="date" required />
              </div>

              <div class="mb-3">
                <label for="time" class="form-label">Время *</label>
                <input type="time" class="form-control" id="time" required />
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Описание</label>
                <textarea
                  class="form-control"
                  id="description"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-primary" id="saveNewEvent">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно редактирования события -->
    <div
      class="modal fade"
      id="editEventModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Редактирование события</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editEventForm">
              <input type="hidden" id="editEventId" />
              <div class="mb-3">
                <label for="editTitle" class="form-label">Название *</label>
                <input
                  type="text"
                  class="form-control"
                  id="editTitle"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editType" class="form-label">Тип *</label>
                <select class="form-select" id="editType" required>
                  <option value="">Выберите тип</option>
                  <option value="Raid">Рейд</option>
                  <option value="Dungeon">Подземелье</option>
                  <option value="WorldBoss">Мировой босс</option>
                  <option value="GuildWar">Война гильдий</option>
                  <option value="Other">Другое</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="editDate" class="form-label">Дата *</label>
                <input
                  type="date"
                  class="form-control"
                  id="editDate"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editTime" class="form-label">Время *</label>
                <input
                  type="time"
                  class="form-control"
                  id="editTime"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editDescription" class="form-label">Описание</label>
                <textarea
                  class="form-control"
                  id="editDescription"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-primary" id="saveEditEvent">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно управления посещаемостью -->
    <div
      class="modal fade"
      id="attendanceModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Управление посещаемостью</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <h5 id="attendanceEventTitle">Загрузка...</h5>
            <p id="attendanceEventDate">Загрузка...</p>

            <div class="alert alert-info mb-3">
              Отметьте участников, которые присутствовали на событии.
            </div>

            <div id="membersAttendanceList">
              <div class="alert alert-info">Загрузка списка участников...</div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-primary" id="saveAttendance">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Гильдия Perfect World Mobile</h5>
            <p>
              Сайт для управления гильдией и отслеживания статистики участников.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <p>&copy; <span id="currentYear"></span> Все права защищены.</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      const supabaseUrl = "https://rlfhdyfjovrlelrxtrhi.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZmhkeWZqb3ZybGVscnh0cmhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MzczOTIsImV4cCI6MjA2NDIxMzM5Mn0.fovIsGABqoC0lXjuynuAW2tbEhlRBY9bGr8UUNJ39Uk";
      const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
    <script>
      document.getElementById("currentYear").textContent =
        new Date().getFullYear();

      // Получить все события
      async function getAllEvents() {
        const { data, error } = await supabase.from("events").select("*");
        if (error) {
          alert("Ошибка загрузки событий: " + error.message);
          return [];
        }
        return data;
      }

      // Добавить событие
      async function saveEvent(event) {
        const { data, error } = await supabase.from("events").insert([event]);
        if (error) {
          alert("Ошибка добавления события: " + error.message);
        }
        return data;
      }

      // Обновить событие
      async function updateEvent(id, event) {
        const { error } = await supabase
          .from("events")
          .update(event)
          .eq("id", id);
        if (error) {
          alert("Ошибка обновления события: " + error.message);
        }
      }

      // Удалить событие
      async function deleteEvent(id) {
        const { error } = await supabase.from("events").delete().eq("id", id);
        if (error) {
          alert("Ошибка удаления события: " + error.message);
        }
      }

      // Загрузка списка событий
      async function loadEvents() {
        const events = await getAllEvents();
        const container = document.getElementById("eventsTableContainer");
        const totalEventsElement = document.getElementById("totalEvents");

        totalEventsElement.textContent = events.length;

        if (events.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">События не найдены. Добавьте первое событие!</div>';
          return;
        }

        let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover filterable-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Дата и время</th>
                                <th>Описание</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

        events.forEach((event, index) => {
          html += `
            <tr data-event-id="${event.id}">
                <td>${index + 1}</td>
                <td>${event.title || "-"}</td>
                <td>${event.type || "-"}</td>
                <td>${event.date || "-"} ${event.time || ""}</td>
                <td>${event.description || "-"}</td>
                <td>
                    <button class="btn btn-sm btn-primary edit-event" data-id="${
                      event.id
                    }">Редактировать</button>
                    <button class="btn btn-sm btn-danger delete-event" data-id="${
                      event.id
                    }">Удалить</button>
                </td>
            </tr>
          `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            `;

        container.innerHTML = html;

        document.querySelectorAll(".edit-event").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const id = parseInt(this.getAttribute("data-id"));
            const { data, error } = await supabase
              .from("events")
              .select("*")
              .eq("id", id)
              .single();
            if (error || !data) {
              alert("Ошибка загрузки события для редактирования");
              return;
            }
            document.getElementById("editEventId").value = data.id;
            document.getElementById("editTitle").value = data.title || "";
            document.getElementById("editType").value = data.type || "";
            document.getElementById("editDate").value = data.date || "";
            document.getElementById("editTime").value = data.time || "";
            document.getElementById("editDescription").value =
              data.description || "";
            const modal = new bootstrap.Modal(
              document.getElementById("editEventModal")
            );
            modal.show();
          });
        });
        document.querySelectorAll(".delete-event").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const id = parseInt(this.getAttribute("data-id"));
            if (confirm("Вы уверены, что хотите удалить это событие?")) {
              await deleteEvent(id);
              await loadEvents();
            }
          });
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadEvents();

        document
          .getElementById("saveNewEvent")
          .addEventListener("click", async function () {
            const title = document.getElementById("title").value;
            const type = document.getElementById("type").value;
            const date = document.getElementById("date").value;
            const time = document.getElementById("time").value;
            const description = document.getElementById("description").value;

            if (!title || !type || !date || !time) {
              alert("Пожалуйста, заполните обязательные поля");
              return;
            }

            const event = {
              title: title,
              type: type,
              date: date,
              time: time,
              description: description,
            };

            await saveEvent(event);

            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addEventModal")
            );
            modal.hide();
            document.getElementById("addEventForm").reset();
            await loadEvents();
          });

        document
          .getElementById("saveEditEvent")
          .addEventListener("click", async function () {
            const id = parseInt(document.getElementById("editEventId").value);
            const title = document.getElementById("editTitle").value;
            const type = document.getElementById("editType").value;
            const date = document.getElementById("editDate").value;
            const time = document.getElementById("editTime").value;
            const description =
              document.getElementById("editDescription").value;

            if (!title || !type || !date || !time) {
              alert("Пожалуйста, заполните обязательные поля");
              return;
            }

            const event = {
              title: title,
              type: type,
              date: date,
              time: time,
              description: description,
            };

            await updateEvent(id, event);

            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editEventModal")
            );
            modal.hide();
            await loadEvents();
          });
      });
    </script>
  </body>
</html>
