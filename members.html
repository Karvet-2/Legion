<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Участники гильдии - Legion</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="py-3">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="mb-0">
              <a href="index.html" class="text-white text-decoration-none">
                <i class="fas fa-dragon me-2"></i>Legion
              </a>
            </h1>
          </div>
          <div class="col-md-6">
            <nav class="navbar navbar-expand-lg navbar-dark">
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">
                      <i class="fas fa-home me-1"></i> Главная
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" href="members.html">
                      <i class="fas fa-users me-1"></i> Участники
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="events.html">
                      <i class="fas fa-calendar-alt me-1"></i> События
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="packs.html">
                      <i class="fas fa-layer-group me-1"></i> Круги
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="statistics.html">
                      <i class="fas fa-chart-bar me-1"></i> Статистика
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">
                      <i class="fas fa-sign-out-alt me-1"></i> Выход
                    </a>
                  </li>
                </ul>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <div class="container mt-5">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <h2 class="mb-0">
                <i class="fas fa-users me-2"></i> Участники гильдии
              </h2>
              <button
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#addMemberModal"
              >
                <i class="fas fa-user-plus me-2"></i> Добавить участника
              </button>
            </div>
            <div class="card-body">
              <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                  <div class="input-group">
                    <span class="input-group-text bg-light">
                      <i class="fas fa-search text-primary"></i>
                    </span>
                    <input
                      type="text"
                      id="tableFilter"
                      class="form-control"
                      placeholder="Поиск по участникам..."
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <span class="input-group-text bg-light">
                      <i class="fas fa-filter text-primary"></i>
                    </span>
                    <select id="packFilter" class="form-select">
                      <option value="0">Все круги</option>
                      <!-- Круги будут добавлены из JavaScript -->
                    </select>
                  </div>
                </div>
              </div>

              <div id="membersTableContainer">
                <div class="alert alert-info">
                  <i class="fas fa-spinner fa-spin me-2"></i> Загрузка данных...
                </div>
              </div>
            </div>
            <div class="card-footer">
              <div class="d-flex justify-content-between">
                <span>
                  <i class="fas fa-users me-2"></i>
                  Всего участников:
                  <strong id="totalMembers" class="text-primary">0</strong>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно добавления участника -->
    <div
      class="modal fade"
      id="addMemberModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-user-plus me-2"></i> Добавление нового участника
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addMemberForm">
              <div class="mb-3">
                <label for="nickname" class="form-label">
                  <i class="fas fa-user me-2"></i>Ник *
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="nickname"
                  required
                  placeholder="Введите никнейм участника"
                />
              </div>

              <div class="mb-3">
                <label for="telegramUsername" class="form-label">
                  <i class="fab fa-telegram me-2"></i>Ник в Telegram
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="telegramUsername"
                  placeholder="Введите ник в Telegram (без @)"
                />
              </div>

              <div class="mb-3">
                <label for="class" class="form-label">
                  <i class="fas fa-hat-wizard me-2"></i>Класс *
                </label>
                <select class="form-select" id="class" required>
                  <option value="">Выберите класс</option>
                  <option value="Страж">Страж</option>
                  <option value="Друид">Друид</option>
                  <option value="Жнец">Жнец</option>
                  <option value="Стрелок">Стрелок</option>
                  <option value="Жрец">Жрец</option>
                  <option value="Лучник">Лучник</option>
                  <option value="Оккультист">Оккультист</option>
                  <option value="Маг">Маг</option>
                  <option value="Воин">Воин</option>
                  <option value="Чародей">Чародей</option>
                  <option value="Призрак">Призрак</option>
                  <option value="Убийца">Убийца</option>
                  <option value="Оборотень">Оборотень</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="battlePower" class="form-label">
                  <i class="fas fa-fist-raised me-2"></i>БМ
                </label>
                <input
                  type="number"
                  class="form-control"
                  id="battlePower"
                  min="1"
                  value="1000"
                  placeholder="Боевая мощь персонажа"
                />
              </div>

              <div class="mb-3">
                <label for="packId" class="form-label">
                  <i class="fas fa-layer-group me-2"></i>Круг
                </label>
                <select class="form-select" id="packId">
                  <option value="0">Без круга</option>
                  <!-- Круги будут добавлены из JavaScript -->
                </select>
              </div>

              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="active"
                  checked
                />
                <label class="form-check-label" for="active">
                  <i class="fas fa-check-circle me-1"></i>Активен
                </label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-2"></i>Отмена
            </button>
            <button type="button" class="btn btn-primary" id="saveMemberBtn">
              <i class="fas fa-save me-2"></i>Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно редактирования участника -->
    <div
      class="modal fade"
      id="editMemberModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-user-edit me-2"></i> Редактирование участника
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editMemberForm">
              <input type="hidden" id="editMemberId" />
              <div class="mb-3">
                <label for="editNickname" class="form-label">
                  <i class="fas fa-user me-2"></i>Ник *
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="editNickname"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editTelegramUsername" class="form-label">
                  <i class="fab fa-telegram me-2"></i>Ник в Telegram
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="editTelegramUsername"
                />
              </div>

              <div class="mb-3">
                <label for="editClass" class="form-label">
                  <i class="fas fa-hat-wizard me-2"></i>Класс *
                </label>
                <select class="form-select" id="editClass" required>
                  <option value="">Выберите класс</option>
                  <option value="Страж">Страж</option>
                  <option value="Друид">Друид</option>
                  <option value="Жнец">Жнец</option>
                  <option value="Стрелок">Стрелок</option>
                  <option value="Жрец">Жрец</option>
                  <option value="Лучник">Лучник</option>
                  <option value="Оккультист">Оккультист</option>
                  <option value="Маг">Маг</option>
                  <option value="Воин">Воин</option>
                  <option value="Чародей">Чародей</option>
                  <option value="Призрак">Призрак</option>
                  <option value="Убийца">Убийца</option>
                  <option value="Оборотень">Оборотень</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="editBattlePower" class="form-label">
                  <i class="fas fa-fist-raised me-2"></i>БМ
                </label>
                <input
                  type="number"
                  class="form-control"
                  id="editBattlePower"
                  min="1"
                />
              </div>

              <div class="mb-3">
                <label for="editPackId" class="form-label">
                  <i class="fas fa-layer-group me-2"></i>Круг
                </label>
                <select class="form-select" id="editPackId">
                  <option value="0">Без круга</option>
                  <!-- Круги будут добавлены из JavaScript -->
                </select>
              </div>

              <div class="mb-3">
                <label for="editNotes" class="form-label">
                  <i class="fas fa-sticky-note me-2"></i>Заметки
                </label>
                <textarea
                  class="form-control"
                  id="editNotes"
                  rows="3"
                ></textarea>
              </div>

              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="editActive"
                />
                <label class="form-check-label" for="editActive">
                  <i class="fas fa-check-circle me-1"></i>Активен
                </label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger me-auto"
              id="deleteMemberBtn"
            >
              <i class="fas fa-trash-alt me-2"></i>Удалить
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-2"></i>Отмена
            </button>
            <button type="button" class="btn btn-primary" id="updateMemberBtn">
              <i class="fas fa-save me-2"></i>Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i> Подтверждение
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Вы действительно хотите удалить участника
              <strong id="deleteUserName"></strong>?
            </p>
            <p class="text-danger">
              <i class="fas fa-exclamation-circle me-2"></i>Это действие нельзя
              отменить!
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-2"></i>Отмена
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              <i class="fas fa-trash-alt me-2"></i>Удалить
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5><i class="fas fa-dragon me-2"></i> Гильдия Legion</h5>
            <p>
              Сайт для управления гильдией и отслеживания статистики участников.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <div class="social-icons mb-3">
              <a href="#" class="text-light me-3"
                ><i class="fab fa-discord fa-lg"></i
              ></a>
              <a href="#" class="text-light me-3"
                ><i class="fab fa-telegram fa-lg"></i
              ></a>
              <a href="#" class="text-light"><i class="fab fa-vk fa-lg"></i></a>
            </div>
            <p>&copy; <span id="currentYear"></span> Все права защищены.</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script src="members.js"></script>
    <script>
      document.getElementById("currentYear").textContent =
        new Date().getFullYear();

      // Проверка авторизации
      if (!isLoggedIn()) {
        window.location.href = "login.html";
      } else if (!isAdmin()) {
        // Если пользователь не администратор, перенаправляем на статистику
        window.location.href = "statistics.html";
      }

      // Загрузка списка кругов
      function loadPacks() {
        const packs = getAllPacks();
        const packFilter = document.getElementById("packFilter");
        const packId = document.getElementById("packId");
        const editPackId = document.getElementById("editPackId");

        // Очищаем и заполняем селект фильтра
        packFilter.innerHTML = '<option value="0">Все круги</option>';

        // Очищаем и заполняем селекты выбора круга
        packId.innerHTML = '<option value="0">Без круга</option>';
        editPackId.innerHTML = '<option value="0">Без круга</option>';

        packs.forEach((pack) => {
          const option1 = document.createElement("option");
          option1.value = pack.id;
          option1.textContent = pack.name;
          packFilter.appendChild(option1);

          const option2 = document.createElement("option");
          option2.value = pack.id;
          option2.textContent = pack.name;
          packId.appendChild(option2);

          const option3 = document.createElement("option");
          option3.value = pack.id;
          option3.textContent = pack.name;
          editPackId.appendChild(option3);
        });
      }

      // Загрузка списка участников
      function loadMembers() {
        const members = getAllMembers();
        const packs = getAllPacks();
        const container = document.getElementById("membersTableContainer");
        const totalMembersElement = document.getElementById("totalMembers");

        totalMembersElement.textContent = members.length;

        if (members.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">Участники гильдии не найдены. Добавьте первого участника!</div>';
          return;
        }

        let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover filterable-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ник</th>
                                <th>Telegram</th>
                                <th>Класс</th>
                                <th>БМ</th>
                                <th>Круг</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

        members.forEach((member, index) => {
          // Получение названия круга
          let packName = "Не назначен";
          const pack = packs.find((p) => p.id === member.packId);
          if (pack) {
            packName = pack.name;
          }

          html += `
                    <tr data-pack-id="${member.packId || 0}">
                        <td>${index + 1}</td>
                        <td>${member.nickname}</td>
                        <td>${member.telegramUsername || "-"}</td>
                        <td>
                            <span class="class-icon class-${member.class.toLowerCase()}"></span>
                            ${member.class}
                        </td>
                        <td>${member.battlePower || 1000}</td>
                        <td>${packName}</td>
                        <td>
                            ${
                              isAdmin()
                                ? `<button class="btn btn-sm btn-primary edit-member" data-id="${member.id}">Редактировать</button>
                            <button class="btn btn-sm btn-danger delete-member delete-confirm" data-id="${member.id}">Удалить</button>`
                                : ""
                            }
                        </td>
                    </tr>
                `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            `;

        container.innerHTML = html;

        // Обработка кнопок действий
        document.querySelectorAll(".view-member").forEach((btn) => {
          btn.addEventListener("click", function () {
            const id = parseInt(this.getAttribute("data-id"));
            viewMember(id);
          });
        });

        document.querySelectorAll(".edit-member").forEach((btn) => {
          btn.addEventListener("click", function () {
            const id = parseInt(this.getAttribute("data-id"));
            openEditModal(id);
          });
        });

        document.querySelectorAll(".delete-member").forEach((btn) => {
          btn.addEventListener("click", function () {
            const id = parseInt(this.getAttribute("data-id"));
            if (confirm("Вы уверены, что хотите удалить этого участника?")) {
              deleteMember(id);
              loadMembers();
            }
          });
        });

        // Фильтрация по кругам
        document
          .getElementById("packFilter")
          .addEventListener("change", function () {
            const packId = parseInt(this.value);
            const rows = document.querySelectorAll(
              ".filterable-table tbody tr"
            );

            rows.forEach((row) => {
              if (
                packId === 0 ||
                parseInt(row.getAttribute("data-pack-id")) === packId
              ) {
                row.style.display = "";
              } else {
                row.style.display = "none";
              }
            });
          });
      }

      // Открытие модального окна для редактирования
      function openEditModal(id) {
        const member = getMemberById(id);
        if (!member) return;

        document.getElementById("editMemberId").value = member.id;
        document.getElementById("editNickname").value = member.nickname;
        document.getElementById("editTelegramUsername").value =
          member.telegramUsername || "";
        document.getElementById("editClass").value = member.class;
        document.getElementById("editBattlePower").value =
          member.battlePower || 1000;
        document.getElementById("editPackId").value = member.packId || 0;
        document.getElementById("editNotes").value = member.notes || "";
        document.getElementById("editActive").checked = member.active;

        const modal = new bootstrap.Modal(
          document.getElementById("editMemberModal")
        );
        modal.show();
      }

      // Просмотр информации об участнике
      function viewMember(id) {
        const member = getMemberById(id);
        if (!member) return;

        // Найдем круг
        const packs = getAllPacks();
        const pack = packs.find((p) => p.id === member.packId);
        const packName = pack ? pack.name : "Не назначен";

        alert(`
                Информация о участнике:
                
                Ник: ${member.nickname}
                Ник в Telegram: ${member.telegramUsername || "-"}
                Класс: ${member.class}
                БМ: ${member.battlePower || 1000}
                Круг: ${packName}
                Заметки: ${member.notes || "-"}
                
                Дата создания: ${formatDate(member.createdAt)}
            `);
      }

      // Инициализация страницы
      document.addEventListener("DOMContentLoaded", function () {
        loadPacks();
        loadMembers();

        // Сохранение нового участника
        document
          .getElementById("saveMemberBtn")
          .addEventListener("click", function () {
            const nickname = document.getElementById("nickname").value;
            const className = document.getElementById("class").value;

            if (!nickname || !className) {
              alert("Пожалуйста, заполните обязательные поля");
              return;
            }

            const member = {
              nickname: nickname,
              class: className,
              level: parseInt(document.getElementById("level").value),
              packId: parseInt(document.getElementById("packId").value),
              notes: document.getElementById("notes").value,
              telegramUsername:
                document.getElementById("telegramUsername").value,
              active: document.getElementById("active").checked,
              battlePower: parseInt(
                document.getElementById("battlePower").value
              ),
            };

            saveMember(member);

            // Скрываем модальное окно
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addMemberModal")
            );
            modal.hide();

            // Очищаем форму
            document.getElementById("addMemberForm").reset();

            // Обновляем список участников
            loadMembers();
          });

        // Сохранение изменений участника
        document
          .getElementById("updateMemberBtn")
          .addEventListener("click", function () {
            const id = parseInt(document.getElementById("editMemberId").value);
            const nickname = document.getElementById("editNickname").value;
            const className = document.getElementById("editClass").value;

            if (!nickname || !className) {
              alert("Пожалуйста, заполните обязательные поля");
              return;
            }

            const member = {
              id: id,
              nickname: nickname,
              class: className,
              level: parseInt(document.getElementById("editLevel").value),
              packId: parseInt(document.getElementById("editPackId").value),
              notes: document.getElementById("editNotes").value,
              telegramUsername: document.getElementById("editTelegramUsername")
                .value,
              active: document.getElementById("editActive").checked,
              battlePower: parseInt(
                document.getElementById("editBattlePower").value
              ),
            };

            saveMember(member);

            // Скрываем модальное окно
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editMemberModal")
            );
            modal.hide();

            // Обновляем список участников
            loadMembers();
          });
      });
    </script>
  </body>
</html>
