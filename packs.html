<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Круги гильдии - Legion</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="bg-dark text-white py-3">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="mb-0">
              <a href="index.html" class="text-white text-decoration-none"
                >Гильдия Legion</a
              >
            </h1>
          </div>
          <div class="col-md-6">
            <nav class="navbar navbar-expand-lg navbar-dark">
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Главная</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="members.html">Участники</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="events.html">События</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" href="packs.html">Круги</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="statistics.html">Статистика</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">Выход</a>
                  </li>
                </ul>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <h2 class="mb-0">Круги гильдии</h2>
              <button
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#addPackModal"
              >
                Добавить круг
              </button>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-12">
                  <input
                    type="text"
                    id="tableFilter"
                    class="form-control"
                    placeholder="Поиск по кругам..."
                  />
                </div>
              </div>

              <div id="packsContainer">
                <div class="alert alert-info">Загрузка данных...</div>
              </div>
            </div>
            <div class="card-footer">
              <div class="d-flex justify-content-between">
                <span>Всего кругов: <strong id="totalPacks">0</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно добавления круга -->
    <div class="modal fade" id="addPackModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Добавление нового круга</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addPackForm">
              <div class="mb-3">
                <label for="name" class="form-label">Название *</label>
                <input type="text" class="form-control" id="name" required />
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Описание</label>
                <textarea
                  class="form-control"
                  id="description"
                  rows="3"
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="color" class="form-label">Цвет круга</label>
                <input
                  type="color"
                  class="form-control form-control-color"
                  id="color"
                  value="#0d6efd"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-primary" id="saveNewPack">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно редактирования круга -->
    <div class="modal fade" id="editPackModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Редактирование круга</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editPackForm">
              <input type="hidden" id="editPackId" />
              <div class="mb-3">
                <label for="editName" class="form-label">Название *</label>
                <input
                  type="text"
                  class="form-control"
                  id="editName"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editDescription" class="form-label">Описание</label>
                <textarea
                  class="form-control"
                  id="editDescription"
                  rows="3"
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="editColor" class="form-label">Цвет круга</label>
                <input
                  type="color"
                  class="form-control form-control-color"
                  id="editColor"
                  value="#0d6efd"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-primary" id="saveEditPack">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно просмотра участников круга -->
    <div
      class="modal fade"
      id="viewPackMembersModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Участники круга</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <h5 id="packTitle" class="mb-3">Загрузка...</h5>

            <div id="packMembersList">
              <div class="alert alert-info">Загрузка списка участников...</div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Закрыть
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Гильдия Perfect World Mobile</h5>
            <p>
              Сайт для управления гильдией и отслеживания статистики участников.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <p>&copy; <span id="currentYear"></span> Все права защищены.</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script src="main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      const supabaseUrl = "https://rlfhdyfjovrlelrxtrhi.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZmhkeWZqb3ZybGVscnh0cmhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MzczOTIsImV4cCI6MjA2NDIxMzM5Mn0.fovIsGABqoC0lXjuynuAW2tbEhlRBY9bGr8UUNJ39Uk";
      const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
    <script>
      document.getElementById("currentYear").textContent =
        new Date().getFullYear();

      // Получить все круги
      async function getAllPacks() {
        const { data, error } = await supabase.from("packs").select("*");
        if (error) {
          alert("Ошибка загрузки кругов: " + error.message);
          return [];
        }
        return data;
      }

      // Добавить круг
      async function savePack(pack) {
        const { data, error } = await supabase.from("packs").insert([pack]);
        if (error) {
          alert("Ошибка добавления круга: " + error.message);
        }
        return data;
      }

      // Обновить круг
      async function updatePack(id, pack) {
        const { error } = await supabase
          .from("packs")
          .update(pack)
          .eq("id", id);
        if (error) {
          alert("Ошибка обновления круга: " + error.message);
        }
      }

      // Удалить круг
      async function deletePack(id) {
        const { error } = await supabase.from("packs").delete().eq("id", id);
        if (error) {
          alert("Ошибка удаления круга: " + error.message);
        }
      }

      // Загрузка списка кругов
      async function loadPacks() {
        const packs = await getAllPacks();
        const container = document.getElementById("packsContainer");
        const totalPacksElement = document.getElementById("totalPacks");

        totalPacksElement.textContent = packs.length;

        if (packs.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">Круги не найдены. Добавьте первый круг!</div>';
          return;
        }

        let html = '<div class="row">';

        packs.forEach((pack) => {
          html += `
            <div class="col-md-4 mb-4">
              <div class="card h-100" data-pack-name="${pack.name.toLowerCase()}">
                <div class="card-header" style="background-color: ${
                  pack.color || "#0d6efd"
                }; color: white;">
                  <h5 class="card-title mb-0">${pack.name}</h5>
                </div>
                <div class="card-body">
                  <p class="card-text">${pack.description || "Нет описания"}</p>
                  <p><strong>ID:</strong> ${pack.id}</p>
                </div>
                <div class="card-footer">
                  <div class="btn-group w-100">
                    <button class="btn btn-sm btn-primary edit-pack" data-id="${
                      pack.id
                    }">Редактировать</button>
                    <button class="btn btn-sm btn-danger delete-pack" data-id="${
                      pack.id
                    }">Удалить</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += "</div>";
        container.innerHTML = html;

        document.querySelectorAll(".edit-pack").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const id = parseInt(this.getAttribute("data-id"));
            const { data, error } = await supabase
              .from("packs")
              .select("*")
              .eq("id", id)
              .single();
            if (error || !data) {
              alert("Ошибка загрузки круга для редактирования");
              return;
            }
            document.getElementById("editPackId").value = data.id;
            document.getElementById("editName").value = data.name || "";
            document.getElementById("editDescription").value =
              data.description || "";
            document.getElementById("editColor").value =
              data.color || "#0d6efd";
            const modal = new bootstrap.Modal(
              document.getElementById("editPackModal")
            );
            modal.show();
          });
        });
        document.querySelectorAll(".delete-pack").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const id = parseInt(this.getAttribute("data-id"));
            if (confirm("Вы уверены, что хотите удалить этот круг?")) {
              await deletePack(id);
              await loadPacks();
            }
          });
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadPacks();

        document
          .getElementById("saveNewPack")
          .addEventListener("click", async function () {
            const name = document.getElementById("name").value;
            const description = document.getElementById("description").value;
            const color = document.getElementById("color").value;

            if (!name) {
              alert("Пожалуйста, заполните название круга");
              return;
            }

            const pack = {
              name: name,
              description: description,
              color: color,
            };

            await savePack(pack);

            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addPackModal")
            );
            modal.hide();
            document.getElementById("addPackForm").reset();
            document.getElementById("color").value = "#0d6efd";
            await loadPacks();
          });

        document
          .getElementById("saveEditPack")
          .addEventListener("click", async function () {
            const id = parseInt(document.getElementById("editPackId").value);
            const name = document.getElementById("editName").value;
            const description =
              document.getElementById("editDescription").value;
            const color = document.getElementById("editColor").value;

            if (!name) {
              alert("Пожалуйста, заполните название круга");
              return;
            }

            const pack = {
              name: name,
              description: description,
              color: color,
            };

            await updatePack(id, pack);

            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editPackModal")
            );
            modal.hide();
            await loadPacks();
          });
      });
    </script>
  </body>
</html>
