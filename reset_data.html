<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Данные в табличном формате - Legion</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-12">
          <div class="card">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <h3>Данные в табличном формате</h3>
              <div>
                <button id="copyTableBtn" class="btn btn-light me-2">
                  <i class="fas fa-copy"></i> Копировать таблицу
                </button>
                <button id="exportCsvBtn" class="btn btn-light">
                  <i class="fas fa-file-export"></i> Экспорт CSV
                </button>
              </div>
            </div>
            <div class="card-body">
              <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="members-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#members"
                    type="button"
                    role="tab"
                  >
                    Участники
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="packs-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#packs"
                    type="button"
                    role="tab"
                  >
                    Круги
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="events-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#events"
                    type="button"
                    role="tab"
                  >
                    События
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="users-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#users"
                    type="button"
                    role="tab"
                  >
                    Пользователи
                  </button>
                </li>
              </ul>

              <div class="tab-content mt-3" id="dataTabsContent">
                <!-- Участники -->
                <div
                  class="tab-pane fade show active"
                  id="members"
                  role="tabpanel"
                >
                  <div class="table-responsive">
                    <table
                      id="membersTable"
                      class="table table-striped table-bordered"
                    >
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Ник</th>
                          <th>Telegram</th>
                          <th>Класс</th>
                          <th>БМ</th>
                          <th>Круг</th>
                          <th>Активен</th>
                          <th>Дата регистрации</th>
                          <th>Заметки</th>
                        </tr>
                      </thead>
                      <tbody id="membersTableBody">
                        <!-- Данные будут добавлены через JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-2">
                    <button id="copyMembersBtn" class="btn btn-primary">
                      Копировать таблицу участников
                    </button>
                    <button
                      id="exportMembersCsvBtn"
                      class="btn btn-secondary ms-2"
                    >
                      Экспорт в CSV
                    </button>
                  </div>
                </div>

                <!-- Круги -->
                <div class="tab-pane fade" id="packs" role="tabpanel">
                  <div class="table-responsive">
                    <table
                      id="packsTable"
                      class="table table-striped table-bordered"
                    >
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Название</th>
                          <th>Описание</th>
                          <th>Цвет</th>
                        </tr>
                      </thead>
                      <tbody id="packsTableBody">
                        <!-- Данные будут добавлены через JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-2">
                    <button id="copyPacksBtn" class="btn btn-primary">
                      Копировать таблицу кругов
                    </button>
                    <button
                      id="exportPacksCsvBtn"
                      class="btn btn-secondary ms-2"
                    >
                      Экспорт в CSV
                    </button>
                  </div>
                </div>

                <!-- События -->
                <div class="tab-pane fade" id="events" role="tabpanel">
                  <div class="table-responsive">
                    <table
                      id="eventsTable"
                      class="table table-striped table-bordered"
                    >
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Название</th>
                          <th>Тип</th>
                          <th>Дата</th>
                          <th>Время</th>
                          <th>Описание</th>
                        </tr>
                      </thead>
                      <tbody id="eventsTableBody">
                        <!-- Данные будут добавлены через JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-2">
                    <button id="copyEventsBtn" class="btn btn-primary">
                      Копировать таблицу событий
                    </button>
                    <button
                      id="exportEventsCsvBtn"
                      class="btn btn-secondary ms-2"
                    >
                      Экспорт в CSV
                    </button>
                  </div>
                </div>

                <!-- Пользователи -->
                <div class="tab-pane fade" id="users" role="tabpanel">
                  <div class="table-responsive">
                    <table
                      id="usersTable"
                      class="table table-striped table-bordered"
                    >
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Имя пользователя</th>
                          <th>Роль</th>
                        </tr>
                      </thead>
                      <tbody id="usersTableBody">
                        <!-- Данные будут добавлены через JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-2">
                    <button id="copyUsersBtn" class="btn btn-primary">
                      Копировать таблицу пользователей
                    </button>
                    <button
                      id="exportUsersCsvBtn"
                      class="btn btn-secondary ms-2"
                    >
                      Экспорт в CSV
                    </button>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <h4>Простой текстовый формат для копирования:</h4>
                <div class="form-floating">
                  <textarea
                    class="form-control"
                    id="plainTextData"
                    style="height: 200px"
                    readonly
                  ></textarea>
                  <label for="plainTextData">Данные в текстовом формате</label>
                </div>
                <button id="copyTextBtn" class="btn btn-primary mt-2">
                  Копировать текст
                </button>
              </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
              <a href="index.html" class="btn btn-secondary"
                >Вернуться на главную</a
              >
              <button id="resetBtn" class="btn btn-danger">
                Сбросить все данные
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="api.js"></script>
    <script>
      // Функция для копирования текста в буфер обмена
      function copyToClipboard(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        alert("Скопировано в буфер обмена!");
      }

      // Функция для экспорта в CSV
      function exportToCsv(data, filename) {
        const csvContent = data;
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Функция для конвертации данных участников в текстовый формат
      function membersToText(members, packs) {
        let text = "Участник\tУр.\tКласс\tПост\tБМ\tВклад\tСтатус\n";
        members.forEach((member) => {
          // Найдем круг
          const pack = packs.find((p) => p.id === member.packId);
          const packName = pack ? pack.name : "Нет круга";

          // Добавляем строку
          text += `${member.nickname}\t79\t${member.class}\t${
            member.active ? "Активен" : "Неактивен"
          }\t${member.battlePower}\t-\t${packName}\n`;
        });
        return text;
      }

      // Функция для конвертации данных в CSV
      function convertToCSV(objArray, headerList) {
        const array =
          typeof objArray !== "object" ? JSON.parse(objArray) : objArray;
        let str = headerList.join(",") + "\r\n";

        for (let i = 0; i < array.length; i++) {
          let line = "";
          for (const index in headerList) {
            const head = headerList[index];
            if (line !== "") line += ",";
            let value = array[i][head] === undefined ? "" : array[i][head];
            // Если в значении есть запятые или кавычки, оборачиваем в кавычки
            if (
              value.toString().includes(",") ||
              value.toString().includes('"')
            ) {
              value = '"' + value.replace(/"/g, '""') + '"';
            }
            line += value;
          }
          str += line + "\r\n";
        }
        return str;
      }

      // Заполнение таблицы участников
      function fillMembersTable() {
        const members = getMembersFromStorage();
        const packs = getPacksFromStorage();
        const tableBody = document.getElementById("membersTableBody");
        tableBody.innerHTML = "";

        members.forEach((member) => {
          const packName = member.packId
            ? packs.find((p) => p.id === member.packId)?.name ||
              "Неизвестный круг"
            : "Нет круга";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${member.id}</td>
            <td>${member.nickname}</td>
            <td>${member.telegramUsername || "-"}</td>
            <td>${member.class}</td>
            <td>${member.battlePower || "-"}</td>
            <td>${packName}</td>
            <td>${member.active ? "Да" : "Нет"}</td>
            <td>${new Date(member.joinDate).toLocaleDateString()}</td>
            <td>${member.notes || "-"}</td>
          `;
          tableBody.appendChild(row);
        });

        // Обновляем текстовый формат
        document.getElementById("plainTextData").value = membersToText(
          members,
          packs
        );
      }

      // Заполнение таблицы кругов
      function fillPacksTable() {
        const packs = getPacksFromStorage();
        const tableBody = document.getElementById("packsTableBody");
        tableBody.innerHTML = "";

        packs.forEach((pack) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${pack.id}</td>
            <td>${pack.name}</td>
            <td>${pack.description || "-"}</td>
            <td style="background-color: ${pack.color}">${pack.color}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      // Заполнение таблицы событий
      function fillEventsTable() {
        const events = getEventsFromStorage();
        const tableBody = document.getElementById("eventsTableBody");
        tableBody.innerHTML = "";

        events.forEach((event) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${event.id}</td>
            <td>${event.title}</td>
            <td>${event.type}</td>
            <td>${event.date}</td>
            <td>${event.time}</td>
            <td>${event.description || "-"}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      // Заполнение таблицы пользователей
      function fillUsersTable() {
        const users = getUsersFromStorage();
        const tableBody = document.getElementById("usersTableBody");
        tableBody.innerHTML = "";

        users.forEach((user) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.role}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      // Заполнение всех таблиц
      function fillAllTables() {
        fillMembersTable();
        fillPacksTable();
        fillEventsTable();
        fillUsersTable();
      }

      // Обработчики событий копирования
      document
        .getElementById("copyMembersBtn")
        .addEventListener("click", function () {
          const table = document.getElementById("membersTable");
          let text = "";

          // Заголовки
          const headers = Array.from(table.querySelectorAll("thead th")).map(
            (th) => th.textContent
          );
          text += headers.join("\t") + "\n";

          // Данные
          const rows = table.querySelectorAll("tbody tr");
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowData = Array.from(cells).map((cell) => cell.textContent);
            text += rowData.join("\t") + "\n";
          });

          copyToClipboard(text);
        });

      document
        .getElementById("copyPacksBtn")
        .addEventListener("click", function () {
          const table = document.getElementById("packsTable");
          let text = "";

          // Заголовки
          const headers = Array.from(table.querySelectorAll("thead th")).map(
            (th) => th.textContent
          );
          text += headers.join("\t") + "\n";

          // Данные
          const rows = table.querySelectorAll("tbody tr");
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowData = Array.from(cells).map((cell) => cell.textContent);
            text += rowData.join("\t") + "\n";
          });

          copyToClipboard(text);
        });

      document
        .getElementById("copyEventsBtn")
        .addEventListener("click", function () {
          const table = document.getElementById("eventsTable");
          let text = "";

          // Заголовки
          const headers = Array.from(table.querySelectorAll("thead th")).map(
            (th) => th.textContent
          );
          text += headers.join("\t") + "\n";

          // Данные
          const rows = table.querySelectorAll("tbody tr");
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowData = Array.from(cells).map((cell) => cell.textContent);
            text += rowData.join("\t") + "\n";
          });

          copyToClipboard(text);
        });

      document
        .getElementById("copyUsersBtn")
        .addEventListener("click", function () {
          const table = document.getElementById("usersTable");
          let text = "";

          // Заголовки
          const headers = Array.from(table.querySelectorAll("thead th")).map(
            (th) => th.textContent
          );
          text += headers.join("\t") + "\n";

          // Данные
          const rows = table.querySelectorAll("tbody tr");
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowData = Array.from(cells).map((cell) => cell.textContent);
            text += rowData.join("\t") + "\n";
          });

          copyToClipboard(text);
        });

      document
        .getElementById("copyTextBtn")
        .addEventListener("click", function () {
          const text = document.getElementById("plainTextData").value;
          copyToClipboard(text);
        });

      // Обработчики экспорта в CSV
      document
        .getElementById("exportMembersCsvBtn")
        .addEventListener("click", function () {
          const members = getMembersFromStorage();
          const packs = getPacksFromStorage();

          // Подготовка данных для CSV
          const csvData = members.map((member) => {
            const packName = member.packId
              ? packs.find((p) => p.id === member.packId)?.name ||
                "Неизвестный круг"
              : "Нет круга";

            return {
              ID: member.id,
              Nickname: member.nickname,
              Telegram: member.telegramUsername || "",
              Class: member.class,
              BattlePower: member.battlePower || "",
              Pack: packName,
              Active: member.active ? "Да" : "Нет",
              JoinDate: new Date(member.joinDate).toLocaleDateString(),
              Notes: member.notes || "",
            };
          });

          const headers = [
            "ID",
            "Nickname",
            "Telegram",
            "Class",
            "BattlePower",
            "Pack",
            "Active",
            "JoinDate",
            "Notes",
          ];
          const csvContent = convertToCSV(csvData, headers);
          exportToCsv(csvContent, "members.csv");
        });

      document
        .getElementById("exportPacksCsvBtn")
        .addEventListener("click", function () {
          const packs = getPacksFromStorage();

          // Подготовка данных для CSV
          const csvData = packs.map((pack) => {
            return {
              ID: pack.id,
              Name: pack.name,
              Description: pack.description || "",
              Color: pack.color || "",
            };
          });

          const headers = ["ID", "Name", "Description", "Color"];
          const csvContent = convertToCSV(csvData, headers);
          exportToCsv(csvContent, "packs.csv");
        });

      document
        .getElementById("exportEventsCsvBtn")
        .addEventListener("click", function () {
          const events = getEventsFromStorage();

          // Подготовка данных для CSV
          const csvData = events.map((event) => {
            return {
              ID: event.id,
              Title: event.title,
              Type: event.type,
              Date: event.date,
              Time: event.time,
              Description: event.description || "",
            };
          });

          const headers = [
            "ID",
            "Title",
            "Type",
            "Date",
            "Time",
            "Description",
          ];
          const csvContent = convertToCSV(csvData, headers);
          exportToCsv(csvContent, "events.csv");
        });

      document
        .getElementById("exportUsersCsvBtn")
        .addEventListener("click", function () {
          const users = getUsersFromStorage();

          // Подготовка данных для CSV
          const csvData = users.map((user) => {
            return {
              ID: user.id,
              Username: user.username,
              Role: user.role,
            };
          });

          const headers = ["ID", "Username", "Role"];
          const csvContent = convertToCSV(csvData, headers);
          exportToCsv(csvContent, "users.csv");
        });

      // Обработчик сброса данных
      document
        .getElementById("resetBtn")
        .addEventListener("click", function () {
          if (
            confirm(
              "Вы уверены, что хотите сбросить все данные? Это действие нельзя отменить!"
            )
          ) {
            localStorage.clear();
            initializeLocalStorage();
            alert("Данные успешно сброшены!");
            fillAllTables();
          }
        });

      // Заполняем таблицы при загрузке страницы
      document.addEventListener("DOMContentLoaded", fillAllTables);

      // Переключение вкладок - обновление текстового поля
      const tabButtons = document.querySelectorAll(
        'button[data-bs-toggle="tab"]'
      );
      tabButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const targetId = this.getAttribute("data-bs-target");
          let textareaContent = "";

          if (targetId === "#members") {
            const members = getMembersFromStorage();
            const packs = getPacksFromStorage();
            textareaContent = membersToText(members, packs);
          } else if (targetId === "#packs") {
            const packs = getPacksFromStorage();
            textareaContent = packs
              .map(
                (pack) => `${pack.id}\t${pack.name}\t${pack.description || "-"}`
              )
              .join("\n");
          } else if (targetId === "#events") {
            const events = getEventsFromStorage();
            textareaContent = events
              .map(
                (event) =>
                  `${event.id}\t${event.title}\t${event.type}\t${event.date} ${event.time}`
              )
              .join("\n");
          } else if (targetId === "#users") {
            const users = getUsersFromStorage();
            textareaContent = users
              .map((user) => `${user.id}\t${user.username}\t${user.role}`)
              .join("\n");
          }

          document.getElementById("plainTextData").value = textareaContent;
        });
      });
    </script>
  </body>
</html>
