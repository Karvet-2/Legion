<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Статистика гильдии - Perfect World Mobile</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header class="bg-dark text-white py-3">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="mb-0">
              <a href="index.html" class="text-white text-decoration-none"
                >Гильдия Perfect World Mobile</a
              >
            </h1>
          </div>
          <div class="col-md-6">
            <nav class="navbar navbar-expand-lg navbar-dark">
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Главная</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="members.html">Участники</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="events.html">События</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="packs.html">Круги</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" href="statistics.html"
                      >Статистика</a
                    >
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">Выход</a>
                  </li>
                </ul>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h2 class="mb-0">Статистика гильдии</h2>
            </div>
            <div class="card-body">
              <ul class="nav nav-tabs" id="statisticsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="overview-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#overview"
                    type="button"
                    role="tab"
                  >
                    Обзор
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="attendance-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#attendance"
                    type="button"
                    role="tab"
                  >
                    Посещаемость
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="classes-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#classes"
                    type="button"
                    role="tab"
                  >
                    Классы
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="activity-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#activity"
                    type="button"
                    role="tab"
                  >
                    Активность
                  </button>
                </li>
              </ul>

              <div class="tab-content mt-3" id="statisticsTabContent">
                <!-- Обзор -->
                <div
                  class="tab-pane fade show active"
                  id="overview"
                  role="tabpanel"
                  aria-labelledby="overview-tab"
                >
                  <div class="row">
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-primary h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title">Всего участников</h5>
                          <h2 id="totalMembersCount">0</h2>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-success h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title">Активных участников</h5>
                          <h2 id="activeMembersCount">0</h2>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-info h-100">
                        <div class="card-body text-center">
                          <div class="stats-icon">
                            <i class="fas fa-layer-group"></i>
                          </div>
                          <div class="stats-number" id="totalPacks">0</div>
                          <div class="stats-label">Всего кругов</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-secondary h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title">Всего событий</h5>
                          <h2 id="totalEventsCount">0</h2>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Распределение по кругам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="packDistributionChart"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 mb-4">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Распределение по классам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="classDistributionChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Статистика событий</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="eventTypeChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Посещаемость -->
                <div
                  class="tab-pane fade"
                  id="attendance"
                  role="tabpanel"
                  aria-labelledby="attendance-tab"
                >
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">
                            Топ-10 участников по посещаемости
                          </h5>
                        </div>
                        <div class="card-body">
                          <canvas id="topAttendanceChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div
                      class="card-header d-flex justify-content-between align-items-center"
                    >
                      <h5 class="mb-0">Подробная статистика посещаемости</h5>
                      <input
                        type="text"
                        id="attendanceTableFilter"
                        class="form-control form-control-sm w-25"
                        placeholder="Поиск по участникам..."
                      />
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Участник</th>
                              <th>Класс</th>
                              <th>Круг</th>
                              <th>Посещено событий</th>
                              <th>% посещаемости</th>
                              <th>Последнее посещение</th>
                            </tr>
                          </thead>
                          <tbody id="attendanceTableBody">
                            <tr>
                              <td colspan="7" class="text-center">
                                Загрузка данных...
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Классы -->
                <div
                  class="tab-pane fade"
                  id="classes"
                  role="tabpanel"
                  aria-labelledby="classes-tab"
                >
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Распределение по классам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="classDistributionChart2"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Средний уровень по классам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="classLevelChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Детализация по классам</h5>
                    </div>
                    <div class="card-body">
                      <div class="row" id="classDetailCards">
                        <!-- Карточки классов будут добавлены из JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Активность -->
                <div
                  class="tab-pane fade"
                  id="activity"
                  role="tabpanel"
                  aria-labelledby="activity-tab"
                >
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">События по месяцам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="eventMonthChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Активность участников</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="memberActivityChart"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Активность по типам событий</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="eventTypeActivityChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Гильдия Perfect World Mobile</h5>
            <p>
              Сайт для управления гильдией и отслеживания статистики участников.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <p>&copy; <span id="currentYear"></span> Все права защищены.</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script src="main.js"></script>
    <script>
      document.getElementById("currentYear").textContent =
        new Date().getFullYear();

      // Проверка авторизации
      if (!isLoggedIn()) {
        window.location.href = "login.html";
      }

      // Загрузка общей статистики
      function loadGeneralStats() {
        const members = getAllMembers();
        const packs = getAllPacks();
        const events = getAllEvents();

        document.getElementById("totalMembersCount").textContent =
          members.length;
        document.getElementById("activeMembersCount").textContent =
          members.filter((m) => m.active).length;
        document.getElementById("totalPacksCount").textContent = packs.length;
        document.getElementById("totalEventsCount").textContent = events.length;
      }

      // Загрузка распределения по кругам
      function loadPackDistribution() {
        const members = getAllMembers();
        const packs = getAllPacks();

        // Подсчет участников по кругам
        const packCounts = {};
        let noPackCount = 0;

        members.forEach((member) => {
          if (member.packId && member.active) {
            const pack = packs.find((p) => p.id === member.packId);
            if (pack) {
              packCounts[pack.name] = (packCounts[pack.name] || 0) + 1;
            }
          } else if (member.active) {
            noPackCount++;
          }
        });

        // Добавляем "Без круга", если есть такие участники
        if (noPackCount > 0) {
          packCounts["Без круга"] = noPackCount;
        }

        // Подготовка данных для графика
        const packLabels = Object.keys(packCounts);
        const packData = packLabels.map((label) => packCounts[label]);
        const packColors = packLabels.map((label, index) => {
          if (label === "Без круга") return "#6c757d";
          const pack = packs.find((p) => p.name === label);
          return pack && pack.color
            ? pack.color
            : `hsl(${(index * 137.5) % 360}, 70%, 60%)`;
        });

        // Создание графика
        const ctx = document
          .getElementById("packDistributionChart")
          .getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: packLabels,
            datasets: [
              {
                data: packData,
                backgroundColor: packColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
              },
              title: {
                display: true,
                text: "Распределение участников по кругам",
              },
            },
          },
        });
      }

      // Загрузка распределения по классам
      function loadClassDistribution() {
        const members = getAllMembers().filter((m) => m.active);

        // Подсчет участников по классам
        const classCounts = {};

        members.forEach((member) => {
          classCounts[member.class] = (classCounts[member.class] || 0) + 1;
        });

        // Подготовка данных для графика
        const classLabels = Object.keys(classCounts);
        const classData = classLabels.map((label) => classCounts[label]);

        // Создание цветов для классов
        const classColors = {
          Mage: "#3498db",
          Warrior: "#e74c3c",
          Archer: "#2ecc71",
          Cleric: "#f1c40f",
          Barbarian: "#9b59b6",
          Assassin: "#1abc9c",
          Wizard: "#34495e",
          Seeker: "#e67e22",
        };

        const backgroundColors = classLabels.map(
          (label) =>
            classColors[label] || `hsl(${Math.random() * 360}, 70%, 60%)`
        );

        // Создание графика
        const ctx = document
          .getElementById("classDistributionChart")
          .getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: classLabels,
            datasets: [
              {
                data: classData,
                backgroundColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
              },
              title: {
                display: true,
                text: "Распределение участников по классам",
              },
            },
          },
        });

        // Дублируем график для вкладки "Классы"
        const ctx2 = document
          .getElementById("classDistributionChart2")
          .getContext("2d");
        new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: classLabels,
            datasets: [
              {
                data: classData,
                backgroundColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
              },
              title: {
                display: true,
                text: "Распределение участников по классам",
              },
            },
          },
        });

        // Создание карточек по классам
        const classDetailCards = document.getElementById("classDetailCards");
        classDetailCards.innerHTML = "";

        classLabels.forEach((className) => {
          const classMembers = members.filter((m) => m.class === className);
          const avgLevel =
            classMembers.reduce((sum, m) => sum + m.level, 0) /
            classMembers.length;

          const card = document.createElement("div");
          card.className = "col-md-3 mb-3";
          card.innerHTML = `
                    <div class="card">
                        <div class="card-header" style="background-color: ${
                          classColors[className]
                        }; color: white;">
                            <h5 class="mb-0">
                                <span class="class-icon class-${className.toLowerCase()}"></span>
                                ${className}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Количество:</strong> ${
                              classMembers.length
                            }</p>
                            <p><strong>Средний уровень:</strong> ${avgLevel.toFixed(
                              1
                            )}</p>
                            <p><strong>Макс. уровень:</strong> ${Math.max(
                              ...classMembers.map((m) => m.level)
                            )}</p>
                        </div>
                    </div>
                `;
          classDetailCards.appendChild(card);
        });

        // График среднего уровня по классам
        const classLevels = {};
        classLabels.forEach((className) => {
          const classMembers = members.filter((m) => m.class === className);
          classLevels[className] =
            classMembers.reduce((sum, m) => sum + m.level, 0) /
            classMembers.length;
        });

        const levelCtx = document
          .getElementById("classLevelChart")
          .getContext("2d");
        new Chart(levelCtx, {
          type: "bar",
          data: {
            labels: classLabels,
            datasets: [
              {
                label: "Средний уровень",
                data: classLabels.map((label) => classLevels[label]),
                backgroundColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Средний уровень по классам",
              },
            },
          },
        });
      }

      // Загрузка статистики событий
      function loadEventStats() {
        const events = getAllEvents();

        // Подсчет событий по типам
        const eventTypeCounts = {};

        events.forEach((event) => {
          eventTypeCounts[event.type] = (eventTypeCounts[event.type] || 0) + 1;
        });

        // Подготовка данных для графика
        const eventTypeLabels = Object.keys(eventTypeCounts);
        const eventTypeData = eventTypeLabels.map(
          (label) => eventTypeCounts[label]
        );

        // Создание цветов для типов событий
        const eventTypeColors = {
          Raid: "#e74c3c",
          Dungeon: "#3498db",
          WorldBoss: "#9b59b6",
          GuildWar: "#f1c40f",
          Other: "#95a5a6",
        };

        const backgroundColors = eventTypeLabels.map(
          (label) =>
            eventTypeColors[label] || `hsl(${Math.random() * 360}, 70%, 60%)`
        );

        // Создание графика
        const ctx = document.getElementById("eventTypeChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: eventTypeLabels.map((type) => {
              switch (type) {
                case "Raid":
                  return "Рейд";
                case "Dungeon":
                  return "Подземелье";
                case "WorldBoss":
                  return "Мировой босс";
                case "GuildWar":
                  return "Война гильдий";
                case "Other":
                  return "Другое";
                default:
                  return type;
              }
            }),
            datasets: [
              {
                label: "Количество событий",
                data: eventTypeData,
                backgroundColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Распределение событий по типам",
              },
            },
          },
        });

        // График активности по типам событий
        const eventTypeActivity = {};
        const allAttendance = getAllAttendance();

        eventTypeLabels.forEach((type) => {
          const typeEvents = events.filter((e) => e.type === type);
          let totalAttendance = 0;

          typeEvents.forEach((event) => {
            const attendance = allAttendance.find(
              (a) => a.eventId === event.id
            );
            if (attendance) {
              totalAttendance += attendance.memberIds.length;
            }
          });

          eventTypeActivity[type] =
            typeEvents.length > 0 ? totalAttendance / typeEvents.length : 0;
        });

        const activityCtx = document
          .getElementById("eventTypeActivityChart")
          .getContext("2d");
        new Chart(activityCtx, {
          type: "bar",
          data: {
            labels: eventTypeLabels.map((type) => {
              switch (type) {
                case "Raid":
                  return "Рейд";
                case "Dungeon":
                  return "Подземелье";
                case "WorldBoss":
                  return "Мировой босс";
                case "GuildWar":
                  return "Война гильдий";
                case "Other":
                  return "Другое";
                default:
                  return type;
              }
            }),
            datasets: [
              {
                label: "Среднее количество участников",
                data: eventTypeLabels.map((label) => eventTypeActivity[label]),
                backgroundColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Среднее количество участников по типам событий",
              },
            },
          },
        });

        // График событий по месяцам
        const eventsByMonth = {};
        const months = [
          "Январь",
          "Февраль",
          "Март",
          "Апрель",
          "Май",
          "Июнь",
          "Июль",
          "Август",
          "Сентябрь",
          "Октябрь",
          "Ноябрь",
          "Декабрь",
        ];

        events.forEach((event) => {
          const date = new Date(event.date);
          const monthYear = `${months[date.getMonth()]} ${date.getFullYear()}`;
          eventsByMonth[monthYear] = (eventsByMonth[monthYear] || 0) + 1;
        });

        const monthCtx = document
          .getElementById("eventMonthChart")
          .getContext("2d");
        new Chart(monthCtx, {
          type: "line",
          data: {
            labels: Object.keys(eventsByMonth),
            datasets: [
              {
                label: "Количество событий",
                data: Object.values(eventsByMonth),
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.2)",
                borderWidth: 2,
                fill: true,
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Количество событий по месяцам",
              },
            },
          },
        });
      }

      // Загрузка статистики посещаемости
      function loadAttendanceStats() {
        const members = getAllMembers().filter((m) => m.active);
        const packs = getAllPacks();
        const events = getAllEvents();
        const attendance = getAllAttendance();

        // Генерация статистики посещаемости
        const stats = generateAttendanceStats();

        // Сортировка по проценту посещаемости (по убыванию)
        stats.sort((a, b) => b.attendanceRate - a.attendanceRate);

        // Заполнение таблицы
        const tableBody = document.getElementById("attendanceTableBody");
        tableBody.innerHTML = "";

        if (stats.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" class="text-center">Нет данных о посещаемости</td></tr>';
          return;
        }

        stats.forEach((stat, index) => {
          const member = members.find((m) => m.id === stat.memberId);
          if (!member) return;

          // Получение названия круга
          let packName = "Не назначена";
          if (member.packId) {
            const pack = packs.find((p) => p.id === member.packId);
            if (pack) packName = pack.name;
          }

          // Получение даты последнего посещения
          let lastAttendance = "Нет данных";
          if (stat.lastEventId) {
            const event = events.find((e) => e.id === stat.lastEventId);
            if (event) {
              lastAttendance = formatDate(event.date + " " + event.time);
            }
          }

          // Перевод названия класса
          let className = member.class;
          switch (member.class) {
            case "Mage":
              className = "Маг";
              break;
            case "Warrior":
              className = "Воин";
              break;
            case "Archer":
              className = "Лучник";
              break;
            case "Cleric":
              className = "Клирик";
              break;
            case "Barbarian":
              className = "Варвар";
              break;
            case "Assassin":
              className = "Ассасин";
              break;
            case "Wizard":
              className = "Волшебник";
              break;
            case "Seeker":
              className = "Искатель";
              break;
          }

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        ${member.nickname}
                    </td>
                    <td>
                        <span class="class-icon class-${member.class.toLowerCase()}"></span>
                        ${className}
                    </td>
                    <td>${packName}</td>
                    <td>${stat.eventsAttended}</td>
                    <td>${(stat.attendanceRate * 100).toFixed(1)}%</td>
                    <td>${lastAttendance}</td>
                `;
          tableBody.appendChild(row);
        });

        // Фильтрация таблицы
        document
          .getElementById("attendanceTableFilter")
          .addEventListener("input", function () {
            const filterText = this.value.toLowerCase();
            const rows = tableBody.querySelectorAll("tr");

            rows.forEach((row) => {
              const memberName = row.cells[1].textContent.trim().toLowerCase();
              if (memberName.includes(filterText)) {
                row.style.display = "";
              } else {
                row.style.display = "none";
              }
            });
          });

        // Создание графика топ-10 по посещаемости
        const top10 = stats.slice(0, 10);
        const top10Ctx = document
          .getElementById("topAttendanceChart")
          .getContext("2d");

        new Chart(top10Ctx, {
          type: "bar",
          data: {
            labels: top10.map((stat) => {
              const member = members.find((m) => m.id === stat.memberId);
              return member ? member.nickname : "Неизвестный";
            }),
            datasets: [
              {
                label: "Процент посещаемости",
                data: top10.map((stat) =>
                  (stat.attendanceRate * 100).toFixed(1)
                ),
                backgroundColor: "#3498db",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Топ-10 участников по посещаемости (%)",
              },
            },
          },
        });

        // График активности участников
        const memberActivityCtx = document
          .getElementById("memberActivityChart")
          .getContext("2d");

        // Распределение участников по кругам активности
        const activityGroups = {
          "Высокая (>75%)": 0,
          "Средняя (50-75%)": 0,
          "Низкая (25-50%)": 0,
          "Очень низкая (<25%)": 0,
        };

        stats.forEach((stat) => {
          if (stat.attendanceRate > 0.75) {
            activityGroups["Высокая (>75%)"]++;
          } else if (stat.attendanceRate > 0.5) {
            activityGroups["Средняя (50-75%)"]++;
          } else if (stat.attendanceRate > 0.25) {
            activityGroups["Низкая (25-50%)"]++;
          } else {
            activityGroups["Очень низкая (<25%)"]++;
          }
        });

        new Chart(memberActivityCtx, {
          type: "pie",
          data: {
            labels: Object.keys(activityGroups),
            datasets: [
              {
                data: Object.values(activityGroups),
                backgroundColor: ["#2ecc71", "#3498db", "#f1c40f", "#e74c3c"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
              },
              title: {
                display: true,
                text: "Распределение участников по активности",
              },
            },
          },
        });
      }

      // Инициализация страницы
      document.addEventListener("DOMContentLoaded", function () {
        loadGeneralStats();
        loadPackDistribution();
        loadClassDistribution();
        loadEventStats();
        loadAttendanceStats();
      });
    </script>
  </body>
</html>
