<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Статистика гильдии - Perfect World Mobile</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header class="bg-dark text-white py-3">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="mb-0">
              <a href="index.html" class="text-white text-decoration-none"
                >Гильдия Perfect World Mobile</a
              >
            </h1>
          </div>
          <div class="col-md-6">
            <nav class="navbar navbar-expand-lg navbar-dark">
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Главная</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="members.html">Участники</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="events.html">События</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="packs.html">Круги</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" href="statistics.html"
                      >Статистика</a
                    >
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">Выход</a>
                  </li>
                </ul>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h2 class="mb-0">Статистика гильдии</h2>
            </div>
            <div class="card-body">
              <ul class="nav nav-tabs" id="statisticsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="overview-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#overview"
                    type="button"
                    role="tab"
                  >
                    Обзор
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="attendance-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#attendance"
                    type="button"
                    role="tab"
                  >
                    Посещаемость
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="classes-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#classes"
                    type="button"
                    role="tab"
                  >
                    Классы
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="activity-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#activity"
                    type="button"
                    role="tab"
                  >
                    Активность
                  </button>
                </li>
              </ul>

              <div class="tab-content mt-3" id="statisticsTabContent">
                <!-- Обзор -->
                <div
                  class="tab-pane fade show active"
                  id="overview"
                  role="tabpanel"
                  aria-labelledby="overview-tab"
                >
                  <div class="row">
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-primary h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title">Всего участников</h5>
                          <h2 id="totalMembersCount">0</h2>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-success h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title">Активных участников</h5>
                          <h2 id="activeMembersCount">0</h2>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-info h-100">
                        <div class="card-body text-center">
                          <div class="stats-icon">
                            <i class="fas fa-layer-group"></i>
                          </div>
                          <div class="stats-number" id="totalPacks">0</div>
                          <div class="stats-label">Всего кругов</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 mb-4">
                      <div class="card text-white bg-secondary h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title">Всего событий</h5>
                          <h2 id="totalEventsCount">0</h2>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Распределение по кругам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="packDistributionChart"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 mb-4">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Распределение по классам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="classDistributionChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Статистика событий</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="eventTypeChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Посещаемость -->
                <div
                  class="tab-pane fade"
                  id="attendance"
                  role="tabpanel"
                  aria-labelledby="attendance-tab"
                >
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">
                            Топ-10 участников по посещаемости
                          </h5>
                        </div>
                        <div class="card-body">
                          <canvas id="topAttendanceChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div
                      class="card-header d-flex justify-content-between align-items-center"
                    >
                      <h5 class="mb-0">Подробная статистика посещаемости</h5>
                      <input
                        type="text"
                        id="attendanceTableFilter"
                        class="form-control form-control-sm w-25"
                        placeholder="Поиск по участникам..."
                      />
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Участник</th>
                              <th>Класс</th>
                              <th>Круг</th>
                              <th>Посещено событий</th>
                              <th>% посещаемости</th>
                              <th>Последнее посещение</th>
                            </tr>
                          </thead>
                          <tbody id="attendanceTableBody">
                            <tr>
                              <td colspan="7" class="text-center">
                                Загрузка данных...
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Классы -->
                <div
                  class="tab-pane fade"
                  id="classes"
                  role="tabpanel"
                  aria-labelledby="classes-tab"
                >
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Распределение по классам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="classDistributionChart2"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Средний уровень по классам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="classLevelChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Детализация по классам</h5>
                    </div>
                    <div class="card-body">
                      <div class="row" id="classDetailCards">
                        <!-- Карточки классов будут добавлены из JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Активность -->
                <div
                  class="tab-pane fade"
                  id="activity"
                  role="tabpanel"
                  aria-labelledby="activity-tab"
                >
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">События по месяцам</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="eventMonthChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Активность участников</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="memberActivityChart"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Активность по типам событий</h5>
                        </div>
                        <div class="card-body">
                          <canvas id="eventTypeActivityChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Гильдия Perfect World Mobile</h5>
            <p>
              Сайт для управления гильдией и отслеживания статистики участников.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <p>&copy; <span id="currentYear"></span> Все права защищены.</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script src="main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      const supabaseUrl = "https://rlfhdyfjovrlelrxtrhi.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZmhkeWZqb3ZybGVscnh0cmhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MzczOTIsImV4cCI6MjA2NDIxMzM5Mn0.fovIsGABqoC0lXjuynuAW2tbEhlRBY9bGr8UUNJ39Uk";
      const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
    <script>
      document.getElementById("currentYear").textContent =
        new Date().getFullYear();

      async function getAllMembers() {
        const { data, error } = await supabase.from("members").select("*");
        if (error) {
          alert("Ошибка загрузки участников: " + error.message);
          return [];
        }
        return data;
      }
      async function getAllPacks() {
        const { data, error } = await supabase.from("packs").select("*");
        if (error) {
          alert("Ошибка загрузки кругов: " + error.message);
          return [];
        }
        return data;
      }
      async function getAllEvents() {
        const { data, error } = await supabase.from("events").select("*");
        if (error) {
          alert("Ошибка загрузки событий: " + error.message);
          return [];
        }
        return data;
      }

      async function loadGeneralStats() {
        const members = await getAllMembers();
        const packs = await getAllPacks();
        const events = await getAllEvents();
        document.getElementById("totalMembersCount").textContent =
          members.length;
        document.getElementById("activeMembersCount").textContent =
          members.filter((m) => m.active).length;
        document.getElementById("totalPacks").textContent = packs.length;
        document.getElementById("totalEventsCount").textContent = events.length;
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadGeneralStats();
        // Здесь можно добавить аналогичные функции для графиков, если нужно
      });
    </script>
  </body>
</html>
